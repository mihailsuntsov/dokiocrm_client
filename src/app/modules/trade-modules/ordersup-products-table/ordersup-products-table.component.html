<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <form #form="ngForm" [formGroup]="formSearch">
                <mat-card class="internal-card">
                    
                    <div class="flex card" style="padding: 0px 15px; font-size: 20px;">
                        <div class="card-name">
                            {{readonly?'Товары из приёмки':'Поиск и добавление товара'}}
                        </div>
                        <div>
                            <button 
                                mat-raised-button 
                                *ngIf="!readonly"
                                matTooltip='Выбрать товары из справочника товаров'
                                (click)="openDialogProductCategoriesSelect('products')" 
                                style="margin-bottom: 10px;"
                                color="primary"
                                type="button"
                                class="button">
                                <i class="material-icons">local_grocery_store</i> Товары
                            </button>
                            <button  
                                mat-raised-button 
                                (click)="addProductRow()" 
                                *ngIf="!readonly"
                                type="submit"
                                style="margin-bottom: 10px;"
                                [disabled]="(!formSearch.valid)||indivisibleErrorOfSearchForm"
                                color="primary"
                                class="button">
                                <i class="material-icons">playlist_add</i> В список
                            </button>
                        </div>
                    </div>
                    <mat-card-content class="input-form">
                        <div class="container-fluid" [hidden]="readonly">
                            <div class="row">
                                <div class="col-lg-1  col-md-12 small-padding center-align">
                                    <div class="div-foto hand"> 
                                        <img *ngIf="productImageName" matTooltip="Посмотреть изображение" (click)="showImage(productImageName)" [src]="imageToShow" width=100%>
                                        <img *ngIf="!productImageName" src="{{thumbImageAddress}}" width=100% style="cursor:default">
                                    </div>          
                                </div>
                                <div class="col-lg-11  col-md-12 small-padding">
                                    <div class="col-12 ">    
                                        <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                            <div class="row">
                                                <div class="col-lg-4  col-md-12">    
                                                    <mat-form-field  style="display: none">
                                                        <input  matInput
                                                        placeholder="product_id"
                                                        formControlName="product_id" [readonly]=true/>
                                                    </mat-form-field>
                                                    <mat-form-field  class="mat-form-field-100">
                                                        <mat-label>Поиск товара</mat-label>
                                                        <input  matInput 
                                                        #productSearchField
                                                        placeholder="Введите часть наименования,артикул или штрих-код" 
                                                        [matAutocomplete]="auto3" 
                                                        [formControl]="searchProductCtrl"
                                                        [readonly]="formSearchReadOnly"
                                                        (input)="canAutocompleteQuery=true; checkEmptyProductField();"
                                                        (change)="canAutocompleteQuery=false; checkEmptyProductField();">
                                                        <button mat-button 
                                                        [matMenuTriggerFor]="productInfo"
                                                        type="button"
                                                        *ngIf="formSearchReadOnly" 
                                                        matTooltip='Показать информацию о товаре'
                                                        matSuffix mat-icon-button>
                                                        <mat-icon>info</mat-icon>
                                                        </button>
                                                        <mat-menu #productInfo="matMenu" xPosition="before">
                                                            <button mat-menu-item>Кол-во на складе: {{+shortInfoAboutProductArray[0]}} {{formSearch.get('edizm').value}}</button>
                                                            <button mat-menu-item>Последнее изменение кол-ва: {{+shortInfoAboutProductArray[1]}} {{formSearch.get('edizm').value}}</button>
                                                            <button mat-menu-item>Дата последнего изменения кол-ва: {{(shortInfoAboutProductArray[2]==null?'нет':shortInfoAboutProductArray[2])}}</button>
                                                            <button mat-menu-item (click)="setPrice(shortInfoAboutProductArray[5])">Последняя закупочная цена: {{+shortInfoAboutProductArray[5]}} руб.</button>
                                                            <button mat-menu-item (click)="setPrice(shortInfoAboutProductArray[3])">Средняя закупочная цена: {{+shortInfoAboutProductArray[3]}} руб.</button>
                                                            <button mat-menu-item (click)="setPrice(shortInfoAboutProductArray[4])">Средняя себестоимость: {{+shortInfoAboutProductArray[4]}} руб.</button>
                                                        </mat-menu>
                                                        <button mat-button 
                                                        type="button"
                                                        (click)="openProductCard(formSearch.get('product_id').value)"
                                                        *ngIf="formSearchReadOnly" 
                                                        matTooltip='Открыть карточку товара'
                                                        matSuffix mat-icon-button >
                                                            <mat-icon>launch</mat-icon>
                                                        </button>
                                                        <button mat-button 
                                                        type="button"
                                                        *ngIf="!formSearchReadOnly" 
                                                        matTooltip='Создать новый товар, и выбрать его для данной приёмки'
                                                        matSuffix mat-icon-button 
                                                        (click)="openDialogCreateProduct();">
                                                            <mat-icon>add</mat-icon>
                                                        </button>

                                                        <button mat-button 
                                                        type="button"
                                                        *ngIf="formSearchReadOnly" 
                                                        matTooltip='Очистить форму поиска'
                                                        matSuffix mat-icon-button 
                                                        (click)="formSearchReadOnly=false;resetFormSearch();">
                                                            <mat-icon>close</mat-icon>
                                                        </button>
                                                        <mat-autocomplete #auto3="matAutocomplete">
                                                            <ng-container *ngIf="!isProductListLoading && filteredProducts.length>1" style="width:320px;">
                                                                <span  *ngFor="let value of filteredProducts"  class="flex" style="border: 0px solid ;margin: 4px 0;">
                                                                    <mat-option style="padding:0px 5px; flex-grow: 1;" [value]="value.name">
                                                                        <div (click)="onSelectProduct(value)">
                                                                            <span class="internal-card">{{value.name}}</span>
                                                                        </div>
                                                                    </mat-option>
                                                                    <mat-chip-list class="mat-chip-list">
                                                                        <mat-chip 
                                                                            *ngIf="value.total>0" 
                                                                            matTooltip="Товар есть в наличии в выбранном отделении"
                                                                            style="margin:12px 5px;flex-grow: 0;">
                                                                            <span style="color:green; font-weight: bold">{{value.total-value.reserved}}</span>
                                                                        </mat-chip>
                                                                        <mat-chip 
                                                                            *ngIf="value.total==0" 
                                                                            matTooltip="Товара нет в наличии в выбранном отделении"
                                                                            style="background-color: #e0e0e0; margin:12px 5px;flex-grow: 0;">
                                                                            <span style="color:rgb(122, 0, 0); font-weight: bold">{{value.total-value.reserved}}</span>
                                                                        </mat-chip>
                                                                    </mat-chip-list>
                                                                </span>
                                                            </ng-container>
                                                        </mat-autocomplete>
                                                    </mat-form-field>
                                                    <mat-progress-bar *ngIf="isProductListLoading" mode="indeterminate"></mat-progress-bar>
                                                </div>
                                                <div class="col-lg-8 col-md-12">
                                                    <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                                        <div class="row">
                                                            <div class="col-lg-1 col-md-12" style="min-width: 100px;"> 
                                                                <mat-form-field  class="mat-form-field-100">
                                                                    <mat-label>Кол-во</mat-label>
                                                                    <input  matInput 
                                                                            #product_count
                                                                            [placeholder]="placeholderActualBalance"
                                                                            formControlName="product_count"
                                                                            (input)="checkProductCountInForm();calcSumPriceOfProduct()"
                                                                            (change)="checkProductCountInForm();calcSumPriceOfProduct()"
                                                                            (keypress)="numberOnlyPlusDotAndComma($event);"
                                                                            [readonly]="+formSearch.get('product_id').value==0?true:false"/>
                                                                    <mat-hint  align="start">
                                                                        <i *ngIf="formSearch.get('product_count').invalid && formSearch.get('product_count').errors.pattern" class="form-invalid">Неправильный формат. Допускается до 6 цифр в целой и до 3 цифр в дробной части. </i>
                                                                        <i *ngIf="formSearch.get('product_count').value!=null && (+formSearch.get('product_count').value==0) && formSearch.get('product_count').value!=''" class="form-invalid">Значение должно быть больше 0</i>
                                                                        <i *ngIf="(formSearch.get('product_count').value==null || formSearch.get('product_count').value=='') && +this.formSearch.get('product_id').value>0" class="form-invalid">Поле не заполнено</i>
                                                                        <i *ngIf="indivisibleErrorOfSearchForm" class="form-invalid">Должно быть целым</i>
                                                                    </mat-hint>
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1 col-md-12" style="min-width: 100px;"> 
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Цена{{formSearch.get('edizm').value==''?'':' за 1 '}}{{formSearch.get('edizm').value}}"
                                                                            formControlName="product_price"
                                                                            (input)="checkProductPriceInForm();calcSumPriceOfProduct()"
                                                                            (change)="checkProductPriceInForm();calcSumPriceOfProduct()"
                                                                            (keypress)="numberOnlyPlusDotAndComma($event)"
                                                                            [readonly]="+formSearch.get('product_id').value==0?true:false"/>
                                                                    <mat-hint align="start">
                                                                        <i *ngIf=" formSearch.get('product_price').invalid && formSearch.get('product_price').errors.pattern && formSearch.get('product_price').value>0 && formSearch.get('product_price').touched" class="form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 2 цифр в дробной части</i>
                                                                        <i *ngIf="(formSearch.get('product_price').value==null || formSearch.get('product_price').value=='') && formSearch.get('product_price').value!='0' && +this.formSearch.get('product_id').value>0 && formSearch.get('product_price').touched" class="form-invalid">Поле не заполнено</i>
                                                                        <i *ngIf="formSearch.get('product_price').value=='0' && formSearch.get('product_price').touched" class="form-invalid">Цена = 0</i>
                                                                        <i *ngIf="formSearch.get('product_price').value<0 && formSearch.get('product_price').value!=''" class="form-invalid">Отрицательная цена!</i>
                                                                    </mat-hint>
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1  col-md-12"  style="min-width: 80px;">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Ед. изм."
                                                                            [ngModel]="formSearch.get('edizm').value"
                                                                            [ngModelOptions]="{standalone: true}"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1  col-md-12" style="min-width: 80px;">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Доступно{{formSearch.get('edizm').value==''?'':', '}}{{formSearch.get('edizm').value}}"
                                                                            formControlName="available"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1  col-md-12" style="min-width: 80px;">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Резервы{{formSearch.get('edizm').value==''?'':', '}}{{formSearch.get('edizm').value}}"
                                                                            formControlName="reserved"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1  col-md-12" style="min-width: 80px;">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Остаток{{formSearch.get('edizm').value==''?'':', '}}{{formSearch.get('edizm').value}}"
                                                                            formControlName="total"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>                                                         
                                                            <div class="col-lg-1  col-md-12" style="min-width: 100px;">
                                                                <mat-form-field  class="mat-form-field-100">
                                                                    <mat-label>НДС</mat-label>
                                                                    <mat-select  formControlName="nds_id"  [disabled]="!nds" (selectionChange)="tableRecount()">                          
                                                                        <mat-option  *ngFor="let rt of spravTaxesSet" [value]="rt.id">
                                                                                {{rt.name}}
                                                                        </mat-option> 
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-1  col-md-12" style="min-width: 100px;">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Сумма, руб."
                                                                            formControlName="product_sumprice"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="container-fluid">

                            <mat-spinner 
                                strokeWidth="3" 
                                class="spinner"
                                style="margin-top:110px;"
                                [diameter]="44"
                                *ngIf="gettingTableData"
                                ></mat-spinner>
                            <div class="row" *ngIf="getControlTablefield().value.length>0" style="margin-right:0;margin-left:0;">
                                
                                <table mat-table #_table  [dataSource]="getControlTablefield().value" 
                                [formGroup]="formBaseInformation" 
                                [trackBy]="trackByIndex" 
                                style="margin-top: 20px;" 
                                class="mat-elevation-z8">

                                    <ng-container matColumnDef="select" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef class="checkbox-col">
                                            <mat-checkbox   (change)="masterToggle()"
                                                            
                                                            [checked]="selection.hasValue()"
                                                            [indeterminate]="selection.hasValue() && !isAllSelected()">
                                            </mat-checkbox>
                                        </th>
                                        <td mat-cell class="checkbox-col" *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <mat-checkbox   (click)="$event.stopPropagation()"
                                                            *ngIf="showCheckbox(row)"
                                                            
                                                            (change)="$event ? clickTableCheckbox(row) : null"
                                                            [checked]="selection.isSelected(row)">
                                            </mat-checkbox>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>

                                    <ng-container matColumnDef="index" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef> index </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span>{{i}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef> </td>uj
                                    </ng-container>

                                    <ng-container matColumnDef="row_id" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef> row_id </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span>{{row.row_id}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef> </td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_id" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef> product_id </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span>{{row.product_id}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef> </td>
                                    </ng-container>
                                    <ng-container matColumnDef="name" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef> Название </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span matTooltip='Открыть карточку товара' class="hand" (click)="openProductCard(row.product_id)">{{row.name}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef> Итого ({{getControlTablefield().value.length}} наим.):</td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_count" [formArrayName]="'ordersupProductTable'">    
                                        <th mat-header-cell *matHeaderCellDef class="cell-padding width-80">
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Количество принимаемого товара">
                                                Количество
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" 
                                        class="cell-padding width-60"
                                        [formGroupName]="i"
                                        [matTooltip]="((getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern)) ? 'Ошибочное значение поля' : ''"
                                        [ngStyle]="   ((getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern))?{'background-color': '#ffe4e1'}:{'background-color': 'white'}"
                                        >
                                            <input matInput 
                                                class="table-field-editable"
                                                [ngClass]="{'table-field-editable':!readonly}"
                                                [readonly]=readonly
                                                style="width:  95%;"
                                                placeholder=""
                                                formControlName="product_count"
                                                (keyup)="onChangeProductCount(i);"
                                                (keypress)="numberOnlyPlusDotAndComma($event)"
                                            />
                                            <control-messages  class="table-form-invalid" [control]="getControlTablefield().controls[i].get('product_count')"></control-messages>
                                            <mat-hint align="start">
                                                <i *ngIf="  getControlTablefield().controls[i].get('product_count').value !='' && 
                                                            getControlTablefield().controls[i].get('indivisible').value && 
                                                            !isInteger(parseFloat(getControlTablefield().controls[i].get('product_count').value))"  class="table-form-invalid">
                                                            Должно быть целым
                                                </i>
                                                <i *ngIf="getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern" class="table-form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 3 цифр в дробной части</i>
                                            </mat-hint>
                                        <td mat-footer-cell *matFooterCellDef class="cell-padding width-60"></td>
                                    </ng-container>
                                    <ng-container matColumnDef="edizm" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef class="cell-padding width-60">Ед. изм.</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i" class="cell-padding width-60"> {{row.edizm}} </td>
                                        <td mat-footer-cell *matFooterCellDef class="cell-padding width-60"></td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_price" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 80px;">
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Цена за единицу товара или услуги">
                                                Цена
                                            </span>
                                        </th>
                                        <td mat-cell 
                                        *matCellDef="let row; let i = index" 
                                        [formGroupName]="i"
                                        [ngStyle]="(+getControlTablefield().controls[i].get('product_price').value==0)?{'background-color': '#ffe4e1'}:{'background-color': 'white'}"
                                        >
                                            <input matInput 
                                                [ngClass]="{'table-field-editable':!readonly}"
                                                [readonly]=readonly
                                                style="width: 95%;"
                                                placeholder=""
                                                formControlName="product_price"
                                                (keyup)="onChangeProductPrice(i);"
                                                (keypress)="numberOnlyPlusDotAndComma($event)"
                                            />
                                            <control-messages  class="table-form-invalid" [control]="getControlTablefield().controls[i].get('product_price')"></control-messages>
                                            <mat-hint align="start" >
                                                <i *ngIf="getControlTablefield().controls[i].get('product_price').invalid && getControlTablefield().controls[i].get('product_price').errors.pattern" class="table-form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 2 цифр в дробной части</i>
                                            </mat-hint>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="nds" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="min-width: 50px;">НДС</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <mat-select  
                                            formControlName="nds_id" 
                                            style="width:  95%;"
                                            (selectionChange)="onChangeProductNds()" 
                                            [ngClass]="{'table-field-editable':!readonly}"
                                            [disabled]=readonly>                          
                                                <mat-option  *ngFor="let rt of spravTaxesSet" [value]="rt.id">
                                                        {{rt.name}}
                                                </mat-option> 
                                            </mat-select>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="total" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>Остаток</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.total}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="reserved" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>В резервах</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.reserved}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="available" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>Доступно</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.available}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_sumprice" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>Сумма</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.product_sumprice}} </td>
                                        <td mat-footer-cell *matFooterCellDef> {{totalProductSumm}}</td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="delete" [formArrayName]="'ordersupProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 30px;"><mat-icon style="cursor: default" (click)="clearTable()">close</mat-icon></th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                                            <mat-icon matTooltip="Удалить товар из таблицы" style="cursor: default" (click)="deleteProductRow(row,i)">delete_forever</mat-icon>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                                    <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr> 
                                </table>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>
            </form>
        </div>
        <!-- <code><pre>{{formBaseInformation.get('ordersupProductTable').value | json}}</pre></code> -->
    </div>
</div>
