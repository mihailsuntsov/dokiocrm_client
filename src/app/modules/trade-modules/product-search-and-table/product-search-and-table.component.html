<!-- <code><pre>{{settingsForm.value | json}}</pre></code> -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <form #form="ngForm" [formGroup]="formSearch">
                <mat-card class="internal-card">
                    
                    <div class="flex card" style="padding: 0px 15px; font-size: 20px;">
                        <div class="card-name">
                            {{readonly?'Реализованные товары':'Поиск и добавление товара'}}
                        </div>
                        <div>
                            
                            <button 
                                mat-raised-button 
                                (click)="addProductRow()" 
                                type="submit"
                                style="margin-bottom: 10px;"
                                [disabled]="(!formSearch.valid) ||
                                ((+formSearch.get('product_count').value==0) && formSearch.get('product_count').value!='') ||
                                (formSearch.get('product_count').value=='') ||
                                indivisibleErrorOfSearchForm ||
                                (formSearch.get('product_price').value==0 && formSearch.get('product_price').value!='')||
                                (formSearch.get('product_price').value=='')"
                                color="primary"
                                class="button">
                                <i class="material-icons">playlist_add</i> В список
                            </button>
                            
                        </div>
                    </div>
                    <mat-card-content class="input-form">
                        <div class="container-fluid" [hidden]="readonly">
                            <div class="row">
                                <div class="col-lg-1  col-md-12 small-padding center-align">
                                    <div class="div-foto hand"> 
                                        <img *ngIf="productImageName" matTooltip="Посмотреть изображение" (click)="showImage(productImageName)" [src]="imageToShow" width=100%>
                                        <img *ngIf="!productImageName" src="{{thumbImageAddress}}" width=100% style="cursor:default">
                                    </div>          
                                </div>
                                <div class="col-lg-11  col-md-12 small-padding">
                                    <div class="col-12 ">    
                                        <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                            <div class="row">
                                                <div class="col-lg-6  col-md-12">    
                                                    <mat-form-field  style="display: none">
                                                        <input  matInput
                                                        placeholder="product_id"
                                                        formControlName="product_id" [readonly]=true/>
                                                    </mat-form-field>
                                                    <mat-form-field  class="mat-form-field-100">
                                                        <mat-label>Поиск товара</mat-label>
                                                        <input  matInput 
                                                        #productSearchFieldValue
                                                        placeholder="Введите часть наименования,артикул или штрих-код" 
                                                        [matAutocomplete]="auto3" 
                                                        [formControl]="searchProductCtrl"
                                                        [readonly]="formSearchReadOnly"
                                                        (input)="canAutocompleteQuery=true; checkEmptyProductField();"
                                                        (change)="canAutocompleteQuery=false; checkEmptyProductField();">
                                                        
                                                        <button mat-button 
                                                        type="button"
                                                        (click)="openProductCard(formSearch.get('product_id').value)"
                                                        *ngIf="formSearchReadOnly" 
                                                        matTooltip='Открыть карточку товара'
                                                        matSuffix mat-icon-button >
                                                            <mat-icon>launch</mat-icon>
                                                        </button>

                                                        <button mat-button 
                                                        type="button"
                                                        *ngIf="formSearchReadOnly" 
                                                        matTooltip='Очистить форму поиска'
                                                        matSuffix mat-icon-button 
                                                        (click)="formSearchReadOnly=false;resetFormSearch();">
                                                            <mat-icon>close</mat-icon>
                                                        </button>
                                                        <mat-autocomplete #auto3="matAutocomplete">
                                                            <ng-container *ngIf="!isProductListLoading && filteredProducts.length>1" style="width:320px;">
                                                                <span  *ngFor="let value of filteredProducts"  class="flex" style="border: 0px solid ;margin: 4px 0;">
                                                                    <mat-option style="padding:0px 5px; flex-grow: 1;" [value]="value.name">
                                                                        <div (click)="onSelectProduct(value)">
                                                                            <span class="internal-card">{{value.name}}</span>
                                                                        </div>
                                                                    </mat-option>
                                                                    <mat-chip-list class="mat-chip-list">
                                                                        <mat-chip 
                                                                            *ngIf="(value.total-value.reserved)>0" 
                                                                            matTooltip="Товар есть в наличии"
                                                                            style="margin:12px 5px;flex-grow: 0;">
                                                                            <span style="color:green; font-weight: bold">{{value.total-value.reserved}}</span>
                                                                        </mat-chip>
                                                                        <mat-chip 
                                                                            *ngIf="(value.total-value.reserved)==0" 
                                                                            [matTooltip]="(value.total_in_all_my_depths-value.reserved_in_all_my_depths)>0?'Товара нет в наличии в выбранном отделении, но есть в других доступных вам отделениях':'Товара нет в наличии ни в одном из доступных вам отделениях'"
                                                                            [ngStyle]="(value.total_in_all_my_depths-value.reserved_in_all_my_depths)>0?{'background-color': 'LightGreen'}:{'background-color': '#e0e0e0'}"
                                                                            style="margin:12px 5px;flex-grow: 0;">
                                                                            <span style="color:rgb(122, 0, 0); font-weight: bold">{{value.total-value.reserved}}</span>
                                                                        </mat-chip>
                                                                    </mat-chip-list>
                                                                </span>
                                                            </ng-container>
                                                        </mat-autocomplete>
                                                    </mat-form-field>
                                                    <mat-progress-bar *ngIf="isProductListLoading" mode="indeterminate"></mat-progress-bar>
                                                </div>
                                                <div class="col-lg-6 col-md-12">
                                                    <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                                        <div class="row">
                                                            <div class="col-lg-3 col-md-12"> 
                                                                <mat-form-field  class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            #countInput
                                                                            placeholder="Количество{{edizmName==''?'':', '}}{{edizmName}}"
                                                                            formControlName="product_count"
                                                                            (input)="calcSumPriceOfProduct();checkIndivisibleErrorOfSearchForm();"
                                                                            (change)="calcSumPriceOfProduct();checkIndivisibleErrorOfSearchForm();"
                                                                            (keypress)="numberOnlyPlusDotAndComma($event)"
                                                                            [readonly]="+formSearch.get('product_id').value==0?true:false"/>
                                                                    <mat-hint  align="start" *ngIf="formSearch.get('product_count').dirty">
                                                                        <i *ngIf="formSearch.get('product_count').invalid && formSearch.get('product_count').errors.pattern" class="form-invalid">Неправильный формат. Допускается до 6 цифр в целой и до 3 цифр в дробной части. </i>
                                                                        <i *ngIf="(+formSearch.get('product_count').value==0) && formSearch.get('product_count').value!=''" class="form-invalid">Должно быть больше 0</i>
                                                                        <i *ngIf="formSearch.get('product_count').value=='' && +this.formSearch.get('product_id').value>0" class="form-invalid">Поле не заполнено</i>
                                                                        <i *ngIf="indivisibleErrorOfSearchForm" class="form-invalid">Должно быть целым</i>
                                                                        <i *ngIf="(+formSearch.get('product_count').value>+formSearch.get('available').value)&&!indivisibleErrorOfSearchForm" class="form-invalid">Доступно {{+formSearch.get('available').value}} {{edizmName}}</i>
                                                                    </mat-hint>
                                                            
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Доступно{{edizmName==''?'':', '}}{{edizmName}}"
                                                                            formControlName="available"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="В резервах{{edizmName==''?'':', '}}{{edizmName}}"
                                                                            formControlName="reserved"
                                                                            [readonly]=true
                                                                            />
                                                                            <button mat-button 
                                                                            type="button"
                                                                            (click)="openDialogProductReserves(formSearch.get('secondaryDepartmentId').value,this.formSearch.get('product_id').value )"
                                                                            *ngIf="+formSearch.get('product_id').value>0" 
                                                                            matTooltip='Показать информацию о других "Заказах клиента" с резервами этого товара в выбранном отделении'
                                                                            matSuffix mat-icon-button>
                                                                            <mat-icon>info</mat-icon>
                                                                            </button>
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Всего{{edizmName==''?'':', '}}{{edizmName}}"
                                                                            formControlName="total"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="display: none;"> 
                                                    <mat-form-field  class="mat-form-field-100">
                                                        <mat-label>Ед. изм.</mat-label>
                                                        <mat-select  formControlName="edizm_id" [disabled]=true>               
                                                            <mat-option [value]="0" selected>-</mat-option>     
                                                            <mat-option  *ngFor="let rt of spravSysEdizmOfProductAll" [value]="rt.id">
                                                                    {{rt.short_name}}
                                                            </mat-option> 
                                                        </mat-select>
                                                    </mat-form-field>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                            <div class="row">
                                                <div class="col-lg-2  col-md-12" (click)="getProductCount()">
                                                    <mat-form-field  class="mat-form-field-100">
                                                        <mat-label>Склад</mat-label>
                                                        <mat-select 
                                                        panelClass="department-list"
                                                        (selectionChange)="onSecondaryDepartmentSelection()"
                                                        formControlName="secondaryDepartmentId">
                                                            <span *ngFor="let department of secondaryDepartments"  class="flex" style="border: 0px solid ;margin: 2px 0; min-width:278px;">
                                                                <mat-option
                                                                    [value]="department.id"
                                                                    style="padding:0px 5px; flex-grow: 1;">
                                                                    {{department.name}}
                                                                </mat-option>
                                                                <mat-chip-list *ngIf="formSearch.get('product_id').value>0" class="mat-chip-list">
                                                                    <mat-chip 
                                                                        *ngIf="(department.total-department.reserved)>0 && !gettingProductCount" 
                                                                        matTooltip="Товар есть в наличии"
                                                                        style="margin: 8px;flex-grow: 0;">
                                                                        <span style="color:green; font-weight: bold">{{department.total-department.reserved}}</span>
                                                                    </mat-chip>
                                                                    <mat-chip 
                                                                        *ngIf="(department.total-department.reserved)==0 && !gettingProductCount" 
                                                                        matTooltip="Товар отстуствует"
                                                                        style="margin: 8px;flex-grow: 0;">
                                                                        <span style="color:rgb(122, 0, 0); font-weight: bold">{{department.total-department.reserved}}</span>
                                                                    </mat-chip>
                                                                </mat-chip-list>
                                                                <mat-spinner 
                                                                    strokeWidth="3" 
                                                                    [diameter]="20"
                                                                    style="margin:10px 15px 10px 0px ;flex-grow: 0;"
                                                                    *ngIf="gettingProductCount"
                                                                    ></mat-spinner>
                                                            </span> 
                                                        </mat-select>
                                                    </mat-form-field>
                                                </div>
                                                <div class="col-lg-2  col-md-12">
                                                    <mat-form-field class="mat-form-field-100">
                                                            <mat-label>Расценивать по</mat-label>
                                                            <mat-select  
                                                            formControlName="pricingType">

                                                                <mat-option 
                                                                value="priceType"
                                                                (click)="priceRecount()" 
                                                                matTooltip='Расценка по типам цены'
                                                                >
                                                                Типу цены
                                                                </mat-option>

                                                                <mat-option 
                                                                value="avgCostPrice"
                                                                (click)="priceRecount()" 
                                                                matTooltip='Расценка на основании средней себестоимости'
                                                                >
                                                                Cр. себестоимости
                                                                </mat-option>

                                                                <mat-option 
                                                                value="lastPurchasePrice"
                                                                (click)="priceRecount()" 
                                                                matTooltip='Расценка на основании последней закупочной цены'
                                                                >
                                                                Последней закупочной цене
                                                                </mat-option>

                                                                <mat-option 
                                                                value="avgPurchasePrice"
                                                                (click)="priceRecount()" 
                                                                matTooltip='Расценка на основании средней закупочной цены'
                                                                >
                                                                Средней закупочной цене
                                                                </mat-option>

                                                                <mat-option 
                                                                value="manual"
                                                                (click)="priceRecount()" 
                                                                matTooltip='Цена устанавливается вручную'
                                                                >
                                                                Вручную
                                                                </mat-option>
                                                            </mat-select>
                                                    </mat-form-field>
                                                </div>
                                                <div class="col-lg-2  col-md-12 flex" id="pricetype">
                                                    <!-- Если расценка по типу цены -->
                                                    <mat-form-field 
                                                        class="mat-form-field-100" 
                                                        style="flex: 0 0 100%;"
                                                        *ngIf="formSearch.get('pricingType').value=='priceType'">
                                                        <mat-label>Тип цены</mat-label>
                                                        <mat-select  [(value)]="formSearch.get('price_type_id').value" (selectionChange)="onPriceTypeSelection()">
                                                            <mat-option  *ngFor="let rdl of receivedPriceTypesList" 
                                                            [value]="rdl.id"
                                                            matTooltip='{{rdl.description}}'>
                                                                    {{rdl.name}}
                                                            </mat-option>
                                                        </mat-select>
                                                    </mat-form-field>
                                                    <button 
                                                    mat-icon-button
                                                    *ngIf="formSearch.get('pricingType').value=='priceType'" 
                                                    [matMenuTriggerFor]="menu" 
                                                    style="position: relative;
                                                    right: 40px;
                                                    top: 0px;
                                                    flex: 0 0 0%;
                                                    color:black;
                                                    z-index: 1000;"
                                                    matTooltip="Выбрать приоритетный тип цен">
                                                        <mat-icon style="font-size: 15px; height: 15px;">settings</mat-icon>
                                                    </button>
                                                    <mat-menu #menu="matMenu">
                                                        <div matTooltip='Тип цены склада. Устанавливается в документе "Отделения"'
                                                        [ngClass]="{highlighted:(priorityTypePriceSide=='sklad')}">
                                                            <button mat-menu-item 
                                                            (click)="onSelectPriorityPriceType(department_type_price_id,'sklad')" 
                                                            [disabled]="+department_type_price_id==0">
                                                            <span class="priceTypeName">{{getPriceTypesNameById(department_type_price_id)}}</span>
                                                            <mat-icon>widgets</mat-icon>
                                                            <span>Склад</span>
                                                            </button>
                                                        </div>
                                                        <div matTooltip='Тип цены покупателя.Устанавливается в справочнике "Контрагенты"'
                                                        [ngClass]="{highlighted:(priorityTypePriceSide=='cagent')}">
                                                            <button mat-menu-item 
                                                            (click)="onSelectPriorityPriceType(cagent_type_price_id,'cagent')" 
                                                            [disabled]="+cagent_type_price_id==0">
                                                            <mat-icon>perm_identity</mat-icon>
                                                            <span>Покупатель</span><span class="priceTypeName">{{getPriceTypesNameById(cagent_type_price_id)}}</span>
                                                            </button>
                                                        </div>
                                                        <div matTooltip='Тип цены, выбранный в качестве цены по умолчанию в справочнике "Типы цен"'
                                                            [ngClass]="{highlighted:(priorityTypePriceSide=='defprice')}">
                                                            <button mat-menu-item 
                                                            (click)="onSelectPriorityPriceType(default_type_price_id,'defprice')" 
                                                            [disabled]="+default_type_price_id==0">
                                                            <mat-icon>signal_cellular_alt</mat-icon>
                                                            <span>Цена по умолчанию</span><span class="priceTypeName">{{getPriceTypesNameById(default_type_price_id)}}</span>
                                                            </button>
                                                        </div>
                                                    </mat-menu>
                                                    <!-- Если расценка по себестоимости, средней закупочной или последней закупочной ценам -->
                                                    <div class="mat-form-field-100 flex" id="costPrice" *ngIf="formSearch.get('pricingType').value=='avgCostPrice'||formSearch.get('pricingType').value=='lastPurchasePrice'||formSearch.get('pricingType').value=='avgPurchasePrice'">
                                                                <button 
                                                                mat-icon-button
                                                                style="position: relative;
                                                                right: 5px;
                                                                top: 11px;
                                                                flex: 0 0 0%;
                                                                color:black;
                                                                z-index: 1000;"
                                                                matTooltip="Нажмите, чтобы сделать скидку"
                                                                [ngClass]="{invisible: formSearch.get('plusMinus').value=='minus'}"
                                                                *ngIf="formSearch.get('changePrice').value>=0"
                                                                (click)="clickPlusMinus('minus')">
                                                                    <mat-icon style="font-size: 15px; height: 15px;">add_box</mat-icon>
                                                                </button>
                                                                <button 
                                                                mat-icon-button
                                                                style="position: relative;
                                                                right: 5px;
                                                                top: 11px;
                                                                flex: 0 0 0%;
                                                                color:black;
                                                                z-index: 1000;"
                                                                matTooltip="Нажмите, чтобы сделать наценку"
                                                                [ngClass]="{invisible: formSearch.get('plusMinus').value=='plus'}"
                                                                *ngIf="formSearch.get('changePrice').value>=0"
                                                                (click)="clickPlusMinus('plus')">
                                                                    <mat-icon style="font-size: 15px; height: 15px;">indeterminate_check_box</mat-icon>
                                                                </button>
                                                                <mat-form-field 
                                                                                style="width:68%;">
                                                                    <input  matInput
                                                                            (input)="priceRecount()"
                                                                            (change)="priceRecount()"
                                                                            (keypress)="numberOnlyPlusDot($event)"
                                                                            placeholder="{{priceUpDownFieldName}}"
                                                                            formControlName="changePrice"
                                                                            />
                                                                </mat-form-field>
                                                                <mat-form-field style="width:32%;margin-left: 5px;">
                                                                    <mat-select formControlName="changePriceType" (selectionChange)="priceRecount()" >
                                                                        <mat-option value="procents">
                                                                        %
                                                                        </mat-option>
                                                                        <mat-option value="currency">
                                                                        руб
                                                                        </mat-option>
                                                                    </mat-select>
                                                                    </mat-form-field>
                                                    </div>
                                                </div>
                                                <!-- (click)="openDialogPricing(formSearch.get('product_id').value,formSearch.get('secondaryDepartmentId').value,formSearch.get('price_type_id').value, 'searchForm')" -->
                                                <div class="col-lg-6 col-md-12">
                                                    <div class="container-fluid" style="padding-right: 0px; padding-left: 0px;">
                                                        <div class="row">
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Цена{{edizmName==''?'':' за 1 '}}{{edizmName}}"
                                                                            formControlName="product_price"
                                                                            (input)="calcSumPriceOfProduct()"
                                                                            (change)="calcSumPriceOfProduct()"
                                                                            (keypress)="numberOnlyPlusDotAndComma($event)"
                                                                            [readonly]="+formSearch.get('product_id').value==0?true:false"/>
                                                                            <button mat-button 
                                                                            type="button"
                                                                            (click)="openDialogPricing(formSearch.get('product_id').value,formSearch.get('secondaryDepartmentId').value,formSearch.get('price_type_id').value, 'searchForm')"
                                                                            *ngIf="+formSearch.get('product_id').value>0" 
                                                                            matTooltip='Расценить товар иначе'
                                                                            matSuffix mat-icon-button>
                                                                            <mat-icon>assessment</mat-icon>
                                                                            </button>
                                                                    <mat-hint align="start">
                                                                        <i *ngIf=" formSearch.get('product_price').invalid && formSearch.get('product_price').errors.pattern && formSearch.get('product_price').value>0 && formSearch.get('product_price').touched" class="form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 2 цифр в дробной части</i>
                                                                        <i *ngIf="formSearch.get('product_price').value=='' && +this.formSearch.get('product_id').value>0 && formSearch.get('product_price').touched" class="form-invalid">Поле не заполнено</i>
                                                                        <i *ngIf="formSearch.get('product_price').value==0 && formSearch.get('product_price').value!=''" class="form-invalid">Цена = 0</i>
                                                                        <i *ngIf="formSearch.get('product_price').value<0 && formSearch.get('product_price').value!=''" class="form-invalid">Отрицательная цена!</i>
                                                                    </mat-hint>
                                                                        
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field class="mat-form-field-100">
                                                                    <input  matInput 
                                                                            placeholder="Сумма, руб."
                                                                            [value]="(+formSearch.get('product_id').value==0 && formSearch.get('product_sumprice').value==0)?'':formSearch.get('product_sumprice').value"
                                                                            [readonly]=true
                                                                            />
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field  class="mat-form-field-100" *ngIf="nds">
                                                                    <mat-label>НДС</mat-label>
                                                                    <mat-select  formControlName="nds_id"  (selectionChange)="tableNdsRecount()" [disabled]=false>                          
                                                                        <mat-option  *ngFor="let rt of spravSysNdsSet" [value]="rt.id">
                                                                                {{rt.name}}
                                                                        </mat-option> 
                                                                    </mat-select>
                                                                </mat-form-field>
                                                            </div>
                                                            <div class="col-lg-3  col-md-12">
                                                                <mat-form-field 
                                                                class="mat-form-field-100" 
                                                                style="margin-top:-9px" 
                                                                *ngIf="parent_document_id=='CustomersOrders'">
                                                                    <mat-slide-toggle 
                                                                    formControlName="reserve"
                                                                    (click)="onClickReserveSwitcher()"
                                                                    matTooltip='Включите, если нужно поставить товар в резерв'
                                                                    >Резерв</mat-slide-toggle>
                                                                    <input matInput hidden/>
                                                                </mat-form-field>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="container-fluid">
                            <div class="row" *ngIf="getControlTablefield().value.length>0 || gettingTableData" style="margin-right:0;margin-left:0;">
                                <mat-spinner 
                                strokeWidth="3" 
                                class="spinner"
                                [diameter]="44"
                                *ngIf="gettingTableData"
                                ></mat-spinner>
                                <table mat-table #_table  
                                [dataSource]="getControlTablefield().value" 
                                [formGroup]="formBaseInformation" 
                                [trackBy]="trackByIndex" 
                                style="margin-top: 20px;" 
                                class="mat-elevation-z8">

                                    <ng-container matColumnDef="select" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef class="checkbox-col">
                                            <mat-checkbox   (change)="masterToggle()"
                                                            
                                                            [checked]="selection.hasValue()"
                                                            [indeterminate]="selection.hasValue() && !isAllSelected()">
                                            </mat-checkbox>
                                        </th>
                                        <td mat-cell class="checkbox-col" *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <mat-checkbox   (click)="$event.stopPropagation()"
                                                            *ngIf="showCheckbox(row)"
                                                            
                                                            (change)="$event ? clickTableCheckbox(row) : null"
                                                            [checked]="selection.isSelected(row)">
                                            </mat-checkbox>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>

                                    <ng-container matColumnDef="name" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef> Название </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span matTooltip='Открыть карточку товара' class="hand" (click)="openProductCard(row.product_id)">{{row.name}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef> Итого ({{getControlTablefield().value.length}} наим.):</td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_count" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 60px;">
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Заказываемое количество товаров или услуг из данного склада или отделения">
                                                Кол-во
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" 
                                        [formGroupName]="i"
                                        [matTooltip]="((getControlTablefield().controls[i].get('product_count').value>(getControlTablefield().controls[i].get('available').value)&&getControlTablefield().controls[i].get('is_material').value)&&!(getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern)) ? 'Количество товара больше доступного количетсва' : ''"
                                        [ngStyle]="   ((getControlTablefield().controls[i].get('product_count').value>(getControlTablefield().controls[i].get('available').value)&&getControlTablefield().controls[i].get('is_material').value)&&!(getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern))?{'background-color': '#ffe4e1'}:{'background-color': 'white'}">
                                            <input matInput 
                                                class="table-field-editable"
                                                [ngClass]="{'table-field-editable':!readonly}"
                                                [readonly]=readonly
                                                style="width:  95%;"
                                                placeholder=""
                                                formControlName="product_count"
                                                (keyup)="onChangeProductCount(i);"
                                            />
                                            <control-messages  class="table-form-invalid" [control]="getControlTablefield().controls[i].get('product_count')"></control-messages>
                                            <mat-hint align="start" >
                                                <i *ngIf="  getControlTablefield().controls[i].get('product_count').value !='' && 
                                                            getControlTablefield().controls[i].get('indivisible').value && 
                                                            !isInteger(parseFloat(getControlTablefield().controls[i].get('product_count').value))"  class="table-form-invalid">
                                                            Должно быть целым
                                                </i>
                                                <i *ngIf="getControlTablefield().controls[i].get('product_count').invalid && getControlTablefield().controls[i].get('product_count').errors.pattern" class="table-form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 3 цифр в дробной части</i>
                                            </mat-hint>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="edizm" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>Ед. изм.</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.edizm}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_price" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 80px;">
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Цена за единицу товара или услуги">
                                                Цена
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                                            
                                            <input matInput 
                                                [ngClass]="{'table-field-editable':!readonly}"
                                                [readonly]=readonly
                                                style="width: 95%;"
                                                placeholder=""
                                                formControlName="product_price"
                                                (keyup)="onChangeProductPrice(i);"
                                                (keypress)="numberOnlyPlusDotAndComma($event)"
                                            />
                                            <control-messages  class="table-form-invalid" [control]="getControlTablefield().controls[i].get('product_price')"></control-messages>
                                            <mat-hint align="start" >
                                                <i *ngIf="getControlTablefield().controls[i].get('product_price').invalid && getControlTablefield().controls[i].get('product_price').errors.pattern" class="table-form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 2 цифр в дробной части</i>
                                            </mat-hint>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="product_sumprice" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>Сумма, руб.</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.product_sumprice}} </td>
                                        <td mat-footer-cell *matFooterCellDef> {{totalProductSumm}}</td>
                                    </ng-container>
                                    <ng-container matColumnDef="reserved_current" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 50px;" >
                                            <span 
                                            style="cursor: default;"
                                            matTooltip="Резервирование товара для текущего Заказа покупателя">
                                            Резерв
                                        </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" 
                                        [formGroupName]="i"
                                        [matTooltip]="((getControlTablefield().controls[i].get('reserved_current').value>(getControlTablefield().controls[i].get('available').value+getControlTablefield().controls[i].get('shipped').value)&&getControlTablefield().controls[i].get('is_material').value)&&!(getControlTablefield().controls[i].get('reserved_current').invalid && getControlTablefield().controls[i].get('reserved_current').errors.pattern)) ? 'Количество резерва больше доступного количетсва' : ''"
                                        [ngStyle]="   ((getControlTablefield().controls[i].get('reserved_current').value>(getControlTablefield().controls[i].get('available').value+getControlTablefield().controls[i].get('shipped').value)&&getControlTablefield().controls[i].get('is_material').value)&&!(getControlTablefield().controls[i].get('reserved_current').invalid && getControlTablefield().controls[i].get('reserved_current').errors.pattern))?{'background-color': '#ffe4e1'}:{'background-color': 'white'}">
                                           
                                        <input matInput 
                                                [ngClass]="{'table-field-editable':!readonly}"
                                                [readonly]=readonly
                                                style="width:  95%;"
                                                *ngIf="getControlTablefield().controls[i].get('is_material').value"
                                                placeholder=""
                                                formControlName="reserved_current"
                                            />
                                            <control-messages  class="table-form-invalid" [control]="getControlTablefield().controls[i].get('reserved_current')"></control-messages>
                                            <mat-hint align="start" >
                                                <i *ngIf="getControlTablefield().controls[i].get('reserved_current').invalid && getControlTablefield().controls[i].get('reserved_current').errors.pattern" class="table-form-invalid">Неправильный формат. Допускается до 7 цифр в целой и до 3 цифр в дробной части</i>
                                            </mat-hint>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>



                                    <ng-container matColumnDef="available" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Доступное для заказа количество товара на складе">
                                                Доступно
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span *ngIf="getControlTablefield().controls[i].get('is_material').value">{{row.available}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="total" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Общее количество товара на складе">
                                                Всего
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span *ngIf="getControlTablefield().controls[i].get('is_material').value">{{row.total}}</span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="reserved" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Количество товара, находящееся в резерве на этом же складе в других Заказах покупателя">
                                                В резервах
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <span 
                                                style="cursor: pointer;"
                                                *ngIf="getControlTablefield().controls[i].get('is_material').value"
                                                (click)="openDialogProductReserves(row.department_id,row.product_id)"
                                                matTooltip='Показать информацию о других "Заказах клиента" с резервами этого товара в отделении {{row.department}}'>
                                                {{row.reserved}} 
                                            </span>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="shipped" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef  style="min-width: 60px;max-width: 70px;">
                                            <span 
                                            style="cursor: default;"
                                            matTooltip="Отгруженное количество товара или количество завершенных услуг из данного заказа">
                                            Отгружено
                                        </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.shipped}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="price_type" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="min-width: 80px;">
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Тип цены, по которому расценивается товар или услуга">
                                                Тип цены
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <mat-select  
                                            formControlName="price_type_id"
                                            (selectionChange)="onChangePriceTypeOfRow(i)"
                                            [ngClass]="{'table-field-editable':!readonly}"
                                            [disabled]="readonly"
                                            style="max-width:  95%;">
                                                <mat-option  *ngFor="let rdl of receivedPriceTypesList" 
                                                [value]="rdl.id"
                                                matTooltip='{{rdl.description}}'>
                                                        {{rdl.name}}
                                                </mat-option>
                                            </mat-select>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="nds" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="min-width: 50px;">НДС</th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> 
                                            <mat-select  
                                            formControlName="nds_id" 
                                            style="width:  95%;"
                                            (selectionChange)="onChangeProductNds()" 
                                            [ngClass]="{'table-field-editable':!readonly}"
                                            [disabled]=false>                          
                                                <mat-option  *ngFor="let rt of spravSysNdsSet" [value]="rt.id">
                                                        {{rt.name}}
                                                </mat-option> 
                                            </mat-select>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="department" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef>
                                            <span 
                                                style="cursor: default;"
                                                matTooltip="Склад или отделение, в котором заказывается товар или выполняется услуга">
                                                Склад
                                            </span>
                                        </th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i"> {{row.department}} </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <ng-container matColumnDef="delete" [formArrayName]="'customersOrdersProductTable'">
                                        <th mat-header-cell *matHeaderCellDef style="width: 30px;"><mat-icon style="cursor: default" (click)="clearTable()">close</mat-icon></th>
                                        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                                            <mat-icon style="cursor: default" (click)="deleteProductRow(row,i)">delete_forever</mat-icon>
                                        </td>
                                        <td mat-footer-cell *matFooterCellDef></td>
                                    </ng-container>
                                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                                    <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr>
                                </table> 
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>
            </form>
        </div>
        <!-- <code><pre>{{formBaseInformation.get('customersOrdersProductTable').value | json}}</pre></code> -->
    </div>
</div>
